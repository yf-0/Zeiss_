var Hatena=Hatena||{};!function(Hatena){var B=Hatena.Bookmark=Hatena.Bookmark||{};if(!B.BookmarkButton){"https:"===location.protocol?B.origin=B.apiOrigin=B.staticOrigin="https://b.hatena.ne.jp":(B.origin="http://b.hatena.ne.jp",B.apiOrigin="http://cdn.api.b.hatena.ne.jp",B.staticOrigin="http://b.st-hatena.com");var match=new RegExp("^((?:local|b(?!log)\\w+)\\.hatena\\.ne\\.jp(?::3000)?)$").exec(location.host),isLocal;match&&(B.origin=B.apiOrigin=B.staticOrigin="http://"+match[1],isLocal=!0);var U=B.ButtonUtils={},extend=U.extend=function(t,e){for(var n in e)t[n]=e[n];return t},E=U.createElement=function(t,e){var n=document.createElement(t);for(var i in e)n[i]=e[i];for(var s=2;s<arguments.length;s++){var o=arguments[s];o.nodeType||(o=document.createTextNode(o)),n.appendChild(o)}return n},getLocation=U.getLocation=function(){var t=location.href;return t.length<document.URL.length&&(t=document.URL),t},View=U.View={root:null,clientLeft:0,clientTop:0,init:function(){this.root="CSS1Compat"===(document.compatMode||"")?document.documentElement:document.body,this.clientLeft=this.root.clientLeft||0,this.clientTop=this.root.clientTop||0},getElementRect:function(t){return this.root||this.init(),this.getElementRect=t.getBoundingClientRect?this.getElementRectByRect:this.getElementRectByOffset,this.getElementRect(t)},getElementRectByRect:function(t){var e=t.getBoundingClientRect(),n=this.getScroll();return{x:e.left+n.x-this.clientLeft,y:e.top+n.y-this.clientTop,width:e.width||e.right-e.left,height:e.height||e.bottom-e.top}},getElementRectByOffset:function(t){for(var e,n=0,i=0,s=t;e=s.offsetParent;s=e)n+=s.offsetLeft,i+=s.offsetTop;return{x:n,y:i,width:t.offsetWidth,height:t.offsetHeight}},getWindowSize:function(){return this.root||this.init(),{width:this.root.clientWidth,height:this.root.clientHeight}},getDocumentSize:function(){return this.root||this.init(),{width:this.root.scrollWidth,height:this.root.scrollHeight}},getScroll:function(){return this.root||this.init(),this.getScroll="number"==typeof window.pageXOffset?this.getScrollByPage:this.getScrollByRoot,this.getScroll()},getScrollByPage:function(){return{x:window.pageXOffset,y:window.pageYOffset}},getScrollByRoot:function(){return{x:this.root.scrollLeft,y:this.root.scrollTop}}},Dispatchable=U.Dispatchable={addEventListener:function(t,e){for(var n=this.getListeners(t),i=0;i<n.length;i++)if(n[i]===e)return;n.push(e)},removeEventListener:function(t,e){for(var n=this.getListeners(t),i=0;i<n.length;i++)if(n[i]===e)return void n.splice(i,1)},dispatchEvent:function(t,e){for(var n=new Dispatchable.Event(t,e),i=this.getListeners(t),s=0;s<i.length;s++)i[s].call(this,n);return!n.defaultPrevented},getListeners:function(t){return this.hasOwnProperty("_listenersMap")||(this._listenersMap={}),this._listenersMap[t]||(this._listenersMap[t]=[])}};Dispatchable.Event=function(t,e){this.type=t,this.data=e,this.defaultPrevented=!1},extend(Dispatchable.Event.prototype,{preventDefault:function(){this.defaultPrevented=!0}});var Observer=U.Observer=function(t,e,n,i){if(this.target=t,this.type=e,this.listener=n,i&&(this.listener="string"==typeof i?function(){return n[i].apply(n,arguments)}:function(){return n.apply(i,arguments)}),!t.addEventListener&&t.attachEvent){var s=this.listener;this.listener=function(e){return s.call(t,Observer.WrappedEvent.create(e))},this.start=this.startAttach,this.stop=this.stopAttach}this.start()};extend(Observer.prototype,{start:function(){this.target.addEventListener(this.type,this.listener,!1)},stop:function(){this.target.removeEventListener(this.type,this.listener,!1)},startAttach:function(){this.target.attachEvent("on"+this.type,this.listener)},stopAttach:function(){this.target.detachEvent("on"+this.type,this.listener)}}),Observer.WrappedEvent={create:function(t){if("message"===t.type)return t;var e=document.createEventObject(t);e._event=t,e.target=t.srcElement;var n=View.getScroll();return e.pageX=t.clientX+n.x-View.clientLeft,e.pageY=t.clientY+n.y-View.clientTop,e.stopPropagation=this.stopPropagation,e.preventDefault=this.preventDefault,e},stopPropagation:function(){this._event.cancelBubble=!0},preventDefault:function(){this._event.returnValue=!1}};var JSON=U.JSON=window.JSON||{_tokenRE:/[{}\[\],:]|-?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?\b|\"(?:[^\u0000-\u001f\"\\]|\\(?:[\"\\\/bfnrt]|u[0-9A-Fa-f]{4}))*\"|\b(?:true|false|null)\b|\s+/g,_escapeChar:function(t){return"\\u"+(65536+t.charCodeAt(0)).toString(16).substring(1)},parse:function(json){if(json=String(json),""!==json.replace(JSON._tokenRE,""))throw new Error("Invalid JSON sytax");return eval("("+json+")")},stringify:function(t){switch(typeof t){case"string":return'"'+t.replace(/[\u0000-\u001f\"\\\u2028\u2029]/g,JSON._escapeChar)+'"';case"number":case"boolean":return""+t;case"object":if(!t)return"null";var e=JSON.stringify,n=Object.prototype.toString.call(t).slice(8,-1);switch(n){case"String":case"Number":case"Boolean":return e(t.valueOf());case"Array":for(var i=[],s=0;s<t.length;s++)i.push(e(t[s]));return"["+i.join(",")+"]";case"Object":var i=[];for(var s in t)t.hasOwnProperty(s)&&i.push(e(s)+":"+e(t[s]));return"{"+i.join(",")+"}"}return"null"}return"null"}},WindowMessenger=U.WindowMessenger=function(t,e){this.win=t,this.origin=e.replace(/^(https?:\/\/[^\/?#]+)[\s\S]*/,"$1"),this.observer=new Observer(window,"message",this,"messageHandler")};extend(WindowMessenger,{usePostMessage:!0,keySeed:65536*Math.random()<<8,createForFrame:function(t,e){var n=t.contentWindow;return n.name=(++this.keySeed).toString(36)+"|"+getLocation(),n.location.replace(e),new this(n,e)}}),extend(WindowMessenger.prototype,Dispatchable),extend(WindowMessenger.prototype,{send:function(t,e){"undefined"==typeof e&&(e=null);var n="HBMessage@"+JSON.stringify({type:t,data:e});this.win.postMessage(n,this.origin)},messageHandler:function(t){var e=t.origin||t.uri.replace(/^(https?:\/\/[^\/?#]+)[\s\S]*/,"$1");if(e===this.origin&&t.source==this.win&&/^HBMessage@/.test(t.data)){var n=JSON.parse(t.data.substring(10));this.dispatchEvent(n.type,n.data)}},destroy:function(){this.observer.stop()}}),window.postMessage||(WindowMessenger=U.WindowMessenger=function(t,e,n){this.win=t,this.url=e.replace(/#[\s\S]*/,""),this.key=n,WindowMessenger.instances[this.key]=this,WindowMessenger.timerId||WindowMessenger.init()},extend(WindowMessenger,{usePostMessage:!1,instances:{},interval:20,timerId:0,createForFrame:function(t,e){var n=t.contentWindow,i=this.makeFNVHash(e+"|"+Math.random()).toString(36);return n.name=i+"|"+getLocation(),n.location.replace(e),new this(n,e,i)},makeFNVHash:function(t){for(var e=2166136261,n=0;n<t.length;n++)e=(16777619*e^t.charCodeAt(n))>>>0;return e},init:function(){this.lastFragment=location.hash;var t=this;this.timerId=window.setInterval(function(){t.observe()},this.interval)},observe:function(){var t=location.hash;if(t!==this.lastFragment){var e=t.match(/^#HBMessage-(\w+)-([^\/]+)\/(.+)/);if(!e)return void(this.lastFragment=t);this.lastFragment=this.lastFragment||"#_";var n=View.getScroll();location.replace(this.lastFragment),window.scrollTo(n.x,n.y);var i=this.instances[e[1]];if(i){var s=decodeURIComponent(e[2]),o=JSON.parse(decodeURIComponent(e[3]));i.dispatchEvent(s,o)}}}}),extend(WindowMessenger.prototype,Dispatchable),extend(WindowMessenger.prototype,{send:function(t,e){"undefined"==typeof e&&(e=null);var n=this.url+"#HBMessage-"+this.key+"-"+encodeURIComponent(t)+"/"+encodeURIComponent(JSON.stringify(e));try{this.win.location.replace(n)}catch(i){this.win.location.href=n}},destroy:function(){delete WindowMessenger.instances[this.key]}})),B.BookmarkButton=function(t){this.url=t.getAttribute("data-hatena-bookmark-url")||B.BookmarkButton.extractURL(t.href)||B.BookmarkButton.getCurrentURL(),this.link=t,this.mode=B.BookmarkButton.isTouchBrowser?"goto-touch":this.link.getAttribute("data-hatena-bookmark-mode"),!WindowMessenger.usePostMessage&&/\bMSIE 7\b/.test(navigator.userAgent)&&window.self!=window.top&&(this.mode="popup"),this.setup()},extend(B.BookmarkButton,{interval:428,timerId:0,setup:function(){if(!this.timerId){var t=this;this.timerId=window.setInterval(function(){t.tryCreate()},this.interval),this.tryCreate()}},lastLinkCount:0,tryCreate:function(){var t=document.getElementsByTagName("a"),e=t.length;if(e!==this.lastLinkCount){for(var n=[],i=/(?:^|\s)hatena-bookmark-button(?:\s|$)/,s=0;e>s;s++)i.test(t[s].className)&&!t[s].getAttribute("data-hatena-bookmark-initialized")&&n.push(t[s]);for(var s=0;s<n.length;s++)new B.BookmarkButton(n[s]);this.lastLinkCount=t.length}},extractURL:function(t){if(!t)return null;var e=t.match(/^http:\/\/b\.hatena\.ne\.jp\/entry\/(?:add\/)?(.+)/);if(!e)return null;var n=e[1],i=n.match(/^(?:https?(?:(:)|(%3A))|(s\/))?/);if(i[2])try{return decodeURIComponent(n)}catch(s){return unescape(n)}return i[1]||(n=i[3]?"https://"+n.substring(2):"http://"+n),n.replace(/%23/g,"#")},getCurrentURL:function(){var t=getLocation(),e=this.getCanonicalURL();if(e){var n=t.indexOf("#");n>=0&&e.indexOf("#")<0&&(e+=t.substring(n)),t=e}return t},getCanonicalURL:function(){for(var t=document.getElementsByTagName("link"),e=0;e<t.length;e++)if("canonical"===t[e].rel.toLowerCase()&&t[e].href){var n=document.createElement("a");return n.href=t[e].href,n.cloneNode(!1).href}return null},isTouchBrowser:/\b(?:iPhone|iPod);| Android /.test(navigator.userAgent),forcedLayout:""}),extend(B.BookmarkButton.prototype,{setup:function(){var t=B.BookmarkButton.forcedLayout||this.link.getAttribute("data-hatena-bookmark-layout");if("simple"===t){this.link.setAttribute("data-hatena-bookmark-initialized","1"),this.observer=new Observer(this.link,"click",this,"clickHandler"),this.button=this.link;var e=this.link.getElementsByTagName("img");this.anchor=1===e.length?e[0]:this.link,isLocal||/^https?:\/\/b\.hatena\.ne\.jp\/(?!articles(?![\w-]))/.test(getLocation())||(this.image=new Image,this.image.src=B.apiOrigin+"/entry/button/?url="+encodeURIComponent(this.url)+"&layout=simple&format=image")}else{var n={vertical:{height:50},"simple-balloon":{width:70,height:20},"standard-balloon":{width:130,height:20},"standard-noballoon":{width:80,height:20},"vertical-balloon":{width:80,height:60}},i=50,s=20;n[t]&&(i=n[t].width||i,s=n[t].height||s),this.frame=E("iframe",{className:"hatena-bookmark-button-frame",title:this.link.title,frameBorder:0,scrolling:"no",allowTransparency:!0,width:i,height:s,src:"javascript:false"}),this.frame.style.cssText="width: "+i+"px; height: "+s+"px;",this.link.parentNode.replaceChild(this.frame,this.link);var o=B.apiOrigin+"/entry/button/?url="+encodeURIComponent(this.url);t&&"standard"!==t&&(o+="&layout="+encodeURIComponent(t));var r=this.link.getAttribute("data-hatena-bookmark-lang");r&&(o+="&lang="+encodeURIComponent(r)),"popup"===this.mode&&(o+="&mode="+encodeURIComponent(this.mode)),this.messenger=WindowMessenger.createForFrame(this.frame,o),this.observer=new Observer(this.messenger,"click",this,"clickHandler"),this._resizeObserver=new Observer(this.messenger,"resize",this,"resizeMessageHandler"),this.button=this.frame,this.anchor=this.frame}},getTitle:function(){var t=this.link.getAttribute("data-hatena-bookmark-title");if(!t&&(t=this.link.getAttribute("data-hatena-bookmark-escaped-title")))try{t=decodeURIComponent(t)}catch(e){}return t||this.url.replace(/#.*/,"")!==getLocation().replace(/#.*/,"")||(t=document.title),t},togglePanel:function(){if(this.panel||(this.panel=new B.BookmarkPanel(this.url,this.getTitle())),this.panel.isShown)this.panel.hide();else{var t=this.link.getAttribute("data-hatena-bookmark-position"),e=this.link.getAttribute("data-hatena-bookmark-hide-bg"),n=!e||"false"!==e.toLowerCase();this.panel.show(this.anchor,t,n)}},gotoTouchEntry:function(){var t=B.origin+"/entry.touch/",e=this.url.match(/^http(s)?:\/\/([\s\S]*)$/);t+=e?(e[1]?"s/":"")+e[2]:this.url,location.href=t.replace(/#/g,"%23")},gotoTouchBookmarklet:function(){var t=B.origin+"/bookmarklet.touch?url="+encodeURIComponent(this.url),e=this.getTitle();e&&(t+="&btitle="+encodeURIComponent(e)),location.href=t},clickHandler:function(t){if(!((t.which||t.button||0)>1))switch(t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),this.mode){case"popup":B.BookmarkPanel.openPopup(this.url,this.getTitle());break;case"goto-touch":this.gotoTouchEntry();break;default:this.togglePanel()}},resizeMessageHandler:function(t){var e=t.data.width+"",n=t.data.height+"";/^\d+$/.test(e)&&(this.frame.style.width=e+"px"),/^\d+$/.test(n)&&(this.frame.style.height=n+"px")},destroy:function(){this.observer&&this.observer.stop(),this._resizeObserver&&this._resizeObserver.stop(),this.messenger&&this.messenger.destroy(),this.panel&&this.panel.destroy(),this.button&&this.button.parentNode&&this.button.parentNode.removeChild(this.button)}}),B.BookmarkPanel=function(t,e){this.url=t,this.title=e||"",this.isShown=!1,this.width=365,this.height=160,this.fixedTo="top",this.hiddenFlashes=[],this.clickObserver=new Observer(document,"click",this,"clickHandler"),this.clickObserver.stop(),this.observers=[this.clickObserver],this.setup()},extend(B.BookmarkPanel,{currentPanel:null,makePanelURL:function(t,e){var n=B.origin+"/entry/panel/?url="+encodeURIComponent(t);return e&&(n+="&btitle="+encodeURIComponent(e)),n},openPopup:function(t,e){{var n=this.makePanelURL(t,e);window.open(n,"hatena_bookmark_panel_popup","width=365,height=220,menubar=no,toolbar=no,resizable=yes")}},hasCommonStyle:!1,setupCommonStyle:function(){if(!this.hasCommonStyle){this.hasCommonStyle=!0;var t="margin: 0; padding: 0; border: none; position: static; float: none; width: auto; height: auto; line-height: 1; vertical-align: baseline; color: #222; background: none; font-style: normal; font-weight:normal; font-size: medium; text-indent: 0; text-align: left; text-decoration: none; letter-spacing: normal; word-spacing: normal; white-space: normal;",e=".hatena-bookmark-bookmark-panel, .hatena-bookmark-bookmark-panel * {"+t+"}";try{var n=document.createElement("style");n.type="text/css",n.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(n)}catch(i){document.createStyleSheet().cssText=e}}},needsRebase:null,getBasePosition:function(){if(null===this.needsRebase){var t=window.getComputedStyle?getComputedStyle(document.body,null):document.body.currentStyle;this.needsRebase=!!t&&"static"!==t.position}return this.needsRebase?View.getElementRect(document.body):{x:0,y:0}}}),extend(B.BookmarkPanel.prototype,{setup:function(){var t=(this.title?"\u300e"+this.title+"\u300f":"\u3053\u306e\u30a8\u30f3\u30c8\u30ea\u30fc")+"\u3092\u306f\u3066\u306a\u30d6\u30c3\u30af\u30de\u30fc\u30af\u306b\u8ffd\u52a0";this.panel=E("div",{className:"hatena-bookmark-bookmark-panel"},this.loading=E("div",null,E("span",null,"Now Loading...")),this.content=E("div",null,this.frame=E("iframe",{title:t,scrolling:"no",frameBorder:0,allowTransparency:!0,src:"javascript:false"}))),this.setupStyle(),document.body.appendChild(this.panel);var e=B.BookmarkPanel.makePanelURL(this.url,this.title);this.messenger=WindowMessenger.createForFrame(this.frame,e),this.observers.push(new Observer(this.frame,"load",this,"showContent"),new Observer(this.messenger,"ready",this,"showContent"),new Observer(this.messenger,"resize",this,"resizeMessageHandler"))},setupStyle:function(){B.BookmarkPanel.setupCommonStyle();var t="width: "+this.width+"px; height: "+this.height+"px;";this.panel.style.cssText="position: absolute; z-index: 10002; display: none; "+t,this.loading.style.cssText="background-color: #fff; border: 3px solid #2c6ebd; -moz-border-radius: 5px; -webkit-border-radius: 5px; border-radius: 5px; text-align: center; width: "+(this.width-6)+"px; height: "+(this.height-6)+"px;",this.loading.firstChild.style.cssText='background: url("'+B.staticOrigin+'/images/loading.gif") left center no-repeat; padding-left: 23px; font-size: 0.85em; position: relative; top: '+(this.height/2-10)+"px;",this.content.style.cssText="display: none;",this.frame.style.cssText="display: block; "+t},show:function(t,e,n){this.isShown||(B.BookmarkPanel.currentPanel&&B.BookmarkPanel.currentPanel.hide(),t&&this.anchorTo(t,e),this.panel.style.display="",this.isShown=!0,this.clickObserver.start(),n&&this.hideFlashes(),B.BookmarkPanel.currentPanel=this,this.loading||this.messenger.send("notifysize"))},hideFlashes:function(){for(var t,e=[],n=document.getElementsByTagName("embed"),i=0;t=n[i];i++)"application/x-shockwave-flash"===t.type&&e.push(t);for(var s,o=document.getElementsByTagName("object"),i=0;s=o[i];i++)("application/x-shockwave-flash"===s.type||"clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"===(s.classid||"").toLowerCase())&&e.push(s);if(e.length)for(var r,a=View.getElementRect(this.panel),h=a.x,l=a.y,c=a.x+a.width,d=a.y+Math.max(a.height,300),i=0;r=e[i];i++){var u=View.getElementRect(r);u.x+u.width<h||c<u.x||u.y+u.height<l||d<u.y||(r.style.visibility="hidden",this.hiddenFlashes.push(r))}},showContent:function(){this.loading&&(this.panel.removeChild(this.loading),this.loading=null,this.content.style.display="")},hide:function(){if(this.isShown){this.panel.style.display="none",this.isShown=!1,this.clickObserver.stop();for(var t,e=0;t=this.hiddenFlashes[e];e++)t.style.visibility="";this.hiddenFlashes=[],B.BookmarkPanel.currentPanel=null}},resize:function(t,e){t>0&&(this.panel.style.width=t+"px",this.frame.style.width=t+"px",this.width=t),e>0&&("bottom"===this.fixedTo&&(this.panel.style.top=parseFloat(this.panel.style.top)+this.height-e+"px"),this.panel.style.height=e+"px",this.frame.style.height=e+"px",this.height=e)},anchorTo:function(t,e){var n=View.getElementRect(t),i=e&&e.indexOf("left")>=0,s=e&&e.indexOf("top")>=0;if(!e){var o=View.getWindowSize(),r=View.getScroll();i=r.x+o.width-n.x<this.width&&n.x+n.width-r.x>=this.width;var a=Math.max(this.height,300);s=r.y+o.height-(n.y+n.height)<a&&n.y-r.y>=a}var h=i?n.x+n.width-this.width:n.x,l=s?n.y-this.height-2:n.y+n.height+2,c=B.BookmarkPanel.getBasePosition();this.panel.style.left=Math.max(h,2)-c.x+"px",this.panel.style.top=Math.max(l,2)-c.y+"px",this.fixedTo=s?"bottom":"top"},clickHandler:function(t){for(var e=t.target;e;e=e.parentNode)if(e===this.panel)return;this.hide()},resizeMessageHandler:function(t){this.resize(t.data.width||-1,t.data.height||-1)},destroy:function(){this.hide();for(var t,e=0;t=this.observers[e];e++)t.stop();this.messenger.destroy(),this.panel.parentNode&&this.panel.parentNode.removeChild(this.panel)}})}}(Hatena),Hatena.Bookmark.BookmarkButton.setup();